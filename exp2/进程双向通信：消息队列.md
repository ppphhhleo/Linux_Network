## 进程双向通信：消息队列



消息队列

* 消息队列是Linux内核地址空间中的**内部链表**，各个进程可以通过它来进行消息传递。
* 进程发送的消息会**按顺序写入消息队列**之中，且每个消息队列都有**IPC标识符唯一**地进行标识。
  * 每个消息队列都有一个ID号
  * 而这个号用来区分不同的消息队列
  * 保证不同消息队列之间不冲突。
  * 而每个消息队列内部也维护了一个独立的链表。



### 消息缓冲区结构

消息缓冲区可以理解成进程通过**消息队列在传送或接收消息时的信息容器**。

* 发送消息：将信息通过消息缓冲区放入队列；
* 读取消息：从队列中取出信息放入接收方缓冲区（先进先出）。
* mtype表示消息类型，一般用正数来表示，其作用是**为某个消息设定一个类型，从而保证自己在消息队列中正确地发送和接收自己的消息**；
  mtext存放消息，可自定义MEX_TEXT

```c
struct msgmbuf {/*消息的缓冲区结构*/
		long mtype; // 注意long与int的字长问题
		char mtext[MAX_TEXT];
		};
struct msgmbuf msg_mbuf;  /*创建消息缓冲区*/ 
```

![image-20220309172444177](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220309172444177.png)

### 键值构建ftok()函数


ftok() 函数，可实现将**文件路径名和队列表示符**，转变成一个系统IPC键值。

一个IPC 键值，唯一对应一个消息队列。

它的函数原型描述如下：

```c
# include <sys/types.h>
# include <sys/ipc,.h>
key_t ftok(const char *pathname, int proj_id);
```

如下，我们将创建两个队列，分别为a和b

```c

char *msgpath1 = "/usr/bin"; /*消息key1产生所用的路径*/
char *msgpath2 = "/usr/bin"; /*消息key2产生所用的路径*/
key1 = ftok(msgpath1,'b'); /*产生key1*/
key2 = ftok(msgpath2,'a'); /*产生key2*/
```



### 消息队列 访问 msgget()函数

该函数用来**创建和访问**一个消息队列。它的原型为：

```c
# include <sys/types.h>
# include <sys/ipc.h>
# include <sys/msg,h>
int msgget(key_t key, int msgflg);
```

* key_t key，ftok()函数生成的唯一IPC键值。

* int msgflg，定义对消息队列的权限操作。其取值有IPC_CREAT与IPC_EXCL两种：
  * IPC_CREAT:若内核中不存在指定队列就创建它；
  * IPC_EXCL: 当与IPC_CREAT一起使用时，若队列已存在则出错(函数返回-1)。

**IPC_CREAT|0666**，表示若内核中不存在指定队列则创建它，同时进程可以对队列消息进行**读写**操作。

### 发送消息msgsnd()函数

通过msgget()函数得到了**队列标识符**，我们就可以在对应的消息队列上来执行相关的读写操作了，msgsnd()函数，用于发送消息。它的原型如下所示：

```c
# include <sys/types.h>
# include <sys/ipc.h>
# include <sys/msg,h>
int msgsnd(int msqid, const void *msgp, size_t msgsz, int msgflg);
```

* 第一个参数是消息队列标识符，**由msgget() 函数获取**；明确向哪个消息队列发送消息。
* 第二个参数是message pointer，代表消息缓冲区变量地址，即指向消息缓冲区（**缓冲区结构，包含消息类型和消息内容，在上文已定义**）；
* 第三个参数是message size，**消息的长度**，以字节为单位，注意，这里的大小单纯指消息的大小，并不含消息类型的大小；
* 第四个参数是message flag，取0，即忽略它；或**设置成IPC_NOWAIT（表示当消息队列满了，不等待）**；若不指定，则默认阻塞等待，直到可以写入为止。

### 接收消息msgrcv()函数

msgrcv()函数，用于接收消息。

```c
# include <sys/types.h>
# include <sys/ipc.h>
# include <sys/msg,h>
int msgrcv(int msqid, void *msgp, size_t msgsz,  long msgtyp, int msgflg);
```

* 第一个参数是消息队列标识符，**调用msgget() 函数获取**；明确从哪个消息队列获取消息。
* 第二个参数是message pointer，指向该消息缓冲区（**缓冲区结构，包含消息类型和消息内容，在上文已定义**）；
* 第三个参数是message size，**消息的长度**，以字节为单位，注意，这里的大小单纯指消息的大小，并不含消息类型的大小；
* 第四个参数**message type**，指定要从队列中获取的**消息类型**。内核将查找队列中具有匹配类型的第一个到达的消息，并把它复制返回到由message pointer指定的地址中。如果mtype = 0，则返回队列中最老的消息，不管类型为多少。
  * 例如，指定mtype 为10，则查找队列中最晚的类型为10的消息，其他类型不管。若此前向队列中发送的消息全为mtype = 11类型，则没有mtype = 10的消息，接收失败。
* 第五个参数是message flag，取0，即忽略它；或**设置成IPC_NOWAIT（表示当消息队列满了，不等待）**；若不指定，则默认阻塞等待，直到可以读取为止。

### 消息控制msgctl()函数

msgctl()函数，用于直接对特定的消息队列，其内部结构进行操作。

该函数，向内核发送一个cmd命令，内核根据此来判断进行何种操作，buf为应用层和内核空间进行数据交换的指针。

cmd可以为如下的操作：

* IPC_STAT：获取队列msqid_ds 结构，并把它存放在buf变量所指定的地址中，通过这种方式，应用层可以获得当前消息队列的设置情况，例如是否有消息到来，消息队列的缓冲区设置等。
* IPC_SET ：设置队列的msqid_ds结构的IPC_PERM成员值，它是从buf中取得该值。通过该命令，应用层可以设置消息队列状态，例如修改消息队列的权限，使其他用户可以访问或者不能访问当前的队列；甚至可以设置消息队列的某些当前值来伪装（？
* IPC_RMID：内核删除队列。（一般常用）

### 构造双向通信机制

根据以上的函数，利用消息队列实现进程通信，我们明确得知：

* 每个消息队列有IPC，队列标识
* 消息缓冲区的结构，可以自定义，包含**消息类型和消息数据**
* 消息队列中的每个消息，也包含**消息类型和消息数据**
* 通信过程，收发均可控制消息类型

对于单向通信，只要保证两个进程读写的是同一个消息队列，并且控制消息类型一致即可。

对于双向通信，A -> B 和 B -> A 的消息，关键在于需要双向的消息，可以从消息类型上实现区分，也可以创建两个消息队列实现分离。

#### 双消息队列

两个消息队列，意味着一个进程分别对两个消息队列单独放入和单独读取。对于消息类型，**仅需要控制对单个队列的操作时，mtype一致即可**。

如图，key1和key2 标识两个消息队列；相同颜色，代表消息类型一致；数字序号，表示FIFO

![image-20220309181545286](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220309181545286.png)



#### 单消息队列

单消息队列，控制：A->B为一种消息类型，B->A为另一种消息类型。

A发什么类型，对应B收什么类型的消息。反之亦是如此。

如图，在同一个消息队列里：相同颜色，代表同一消息类型；数字序号，代表该类型消息的FIFO

![image-20220309181924812](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220309181924812.png)





演示效果，当一方发出end，则终止对话。

![image-20220309200143001](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220309200143001.png)



参考文章：https://www.cxyzjd.com/article/qq_36779888/88703088 